<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Mic → Concise AI</title>
    <style>
        :root{--bg:#0f1724;--card:#0b1220;--muted:#94a3b8;--accent:#06b6d4;--glass:rgba(255,255,255,0.03)}
        *{box-sizing:border-box}
        body{font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto; margin:0; min-height:100vh; display:grid; place-items:center; background:linear-gradient(180deg,#071029 0%,#071726 100%); color:#e6eef6}
        .wrap{width:min(760px,94vw); background:var(--card); border-radius:14px; padding:22px; box-shadow:0 6px 30px rgba(2,6,23,0.6); border:1px solid rgba(255,255,255,0.03)}
        header{display:flex;gap:12px;align-items:center;justify-content:center;flex-direction:column}
        header h1{font-size:1.2rem;margin:0}
        header p{margin:0;color:var(--muted);font-size:0.9rem}
        .answer{margin-top:18px; background:var(--glass); padding:16px; border-radius:10px; min-height:84px; display:flex; align-items:center; justify-content:center; text-align:center; font-size:1rem; color:#dff6fb}
        .controls{display:flex; gap:10px; margin-top:14px; justify-content:center}
        button{cursor:pointer;padding:10px 14px;border-radius:12px;border:none;background:linear-gradient(90deg,#083047,#0a6b78);color:white;font-weight:600}
        button.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06); color:var(--muted); font-weight:600}
        .small{font-size:0.9rem;padding:8px 10px;border-radius:10px}
        .meta{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:12px}
        .chip{background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:999px;font-size:0.82rem;color:var(--muted)}
        .recording{box-shadow:0 6px 30px rgba(3, 105, 161, 0.12); outline:2px solid rgba(6,182,212,0.12)}
        .concise{font-weight:700}
    </style>
</head>
<body>
<div class="wrap">
    <header>
        <h1>Mic → Concise AI</h1>
        <p>Speak. Get one short answer.</p>
    </header>

    <div id="answer" class="answer">Press ▶︎ Start and ask your question</div>

    <div class="controls">
        <button id="start" class="small">▶︎ Start</button>
        <button id="stop" class="small secondary" disabled>■ Stop</button>
        <button id="clear" class="small secondary">✕ Clear</button>
        <button id="copy" class="small secondary">⧉ Copy</button>
    </div>

    <div class="meta">
        <div class="chip" id="status">Idle</div>
        <div class="chip" id="lang">Lang: auto</div>
    </div>
</div>

<script>
    const startBtn = document.getElementById('start');
    const stopBtn = document.getElementById('stop');
    const clearBtn = document.getElementById('clear');
    const copyBtn = document.getElementById('copy');
    const answerEl = document.getElementById('answer');
    const statusEl = document.getElementById('status');

    let mediaRecorder;
    let audioChunks = [];

    function setStatus(t){ statusEl.textContent = t; }

    async function initRecorder(){
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);

      mediaRecorder.onstart = () => {
        audioChunks = [];
        document.querySelector('.wrap').classList.add('recording');
        startBtn.disabled = true;
        stopBtn.disabled = false;
        setStatus('Recording...');
        answerEl.textContent = 'Recording your voice...';
      };

      mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) {
          audioChunks.push(e.data);
        }
      };

      mediaRecorder.onstop = async () => {
        document.querySelector('.wrap').classList.remove('recording');
        startBtn.disabled = false;
        stopBtn.disabled = true;
        setStatus('Processing...');
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        sendForAnswer(audioBlob);
      };
    }

    startBtn.addEventListener('click', async ()=>{
      if(!mediaRecorder){ await initRecorder(); }
      mediaRecorder.start();
    });

    stopBtn.addEventListener('click', ()=>{
      if(mediaRecorder && mediaRecorder.state !== 'inactive'){
        mediaRecorder.stop();
      }
    });

    clearBtn.addEventListener('click', ()=>{
      answerEl.textContent = 'Press ▶︎ Start and ask your question';
      setStatus('Idle');
    });

    copyBtn.addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(answerEl.textContent); setStatus('Copied'); setTimeout(()=>setStatus('Idle'),1200); } catch(e){ setStatus('Copy failed'); }
    });

    async function sendForAnswer(audioBlob){
      setStatus('Sending to AI...');
      answerEl.textContent = 'Thinking...';
      try{
        const formData = new FormData();
        formData.append('audio', audioBlob, 'recording.wav');

        const res = await fetch('http://localhost:8080/api/voice', {
          method:'POST', body: formData
        });

        const json = await res.json();
        let ans = (json && json.text) ? String(json.text).trim() : '';

        // ✅ Clean up messy newlines
        ans = ans.replace(/\\n/g, '\n').replace(/\s+/g, ' ').trim();

        // ✅ Split into sentences/points
        let points = ans.split(/[\n•\-]+/).map(p => p.trim()).filter(p => p);

        // ✅ Limit to 6–7 points max
        points = points.slice(0, 7);

        // ✅ Render as bullet list
        if(points.length > 1){
          answerEl.innerHTML = '<ul style="text-align:left;">' +
            points.map(p => `<li>${p}</li>`).join('') +
            '</ul>';
        } else {
          answerEl.textContent = points[0] || 'No answer';
        }

        answerEl.classList.add('concise');
        setStatus('Done');
      } catch(err){
        console.error(err);
        answerEl.textContent = 'Error — could not reach server';
        setStatus('Error');
      }
    }
</script>
</body>
</html>
